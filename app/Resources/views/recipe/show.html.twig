{% extends 'base.html.twig' %}

{% block sidenav %}
<li class="no-padding">
  <ul class="collapsible collapsible-accordion">
    <li>
      <a class="collapsible-header">Minuteries<i class="material-icons">arrow_drop_down</i></a>
      <div class="collapsible-body">
        <ul>
          {% for timer in recipe.timers %}
          <li>
            <a class="chrono" running=false data="{{ timer.time }}" init="{{ timer.time }}">
              {{ timer.name }} :  <span class="time">{{ timer.time|secondToTime }}</span>
              <i class="material-icons timer reset">refresh</i>
              <i class="material-icons timer play">play_circle_filled</i>
            </a>
          </li>
          {% endfor %}
        </ul>
      </div>
    </li>
  </ul>
</li>
{% endblock %}

{% block body %}
<div class="card hoverable">
  <div class="card-image">
    <img src="{% path recipe.media, 'big' %}">
  </div>
  <div class="card-content row">
    <h1>{{ recipe.name }}</h1>
    <div class="col s6">
      <ul class="collection with-header">
        <li class="collection-item">
          <i class="material-icons">people</i> Quantité
          <span class="secondary-content">
            {% if recipe.forPerson is not null %}{{ recipe.forPerson }} personnes {% else %} -- {% endif %}
          </span>
        </li>
        <li class="collection-item">
          <i class="material-icons">alarm</i>Préparation
          <span class="secondary-content">
            {{ recipe.preparationTime }} min
          </span>
        </li>
        <li class="collection-item">
          <i class="material-icons">whatshot</i>Cuisson
          <span class="secondary-content">
            {% if recipe.cookTime is not null %}{{ recipe.cookTime }} min {% else %} -- {% endif %}
          </span>
        </li>
        <li class="collection-item">
          <i class="material-icons">restore</i>Repos
          <span class="secondary-content">
            {% if recipe.restTime is not null %}{{ recipe.restTime }} min {% else %} -- {% endif %}
          </span>
        </li>
      </ul>
    </div>
    <div class="col s6">
      <ul class="collection with-header">
        {% for part in recipe.ingredients|sortByPart %}
        {% if part.id is defined %}
        <li class="collection-header"><h4>First Names</h4></li>
        {% endif %}
        {% for recipeHasIngredient in part.ingredients %}
        <li class="collection-item">
          {{ recipeHasIngredient.ingredient.name }}
          <span class="secondary-content">
            {% if recipeHasIngredient.ingredient.units|length > 0  %}
            <span>{{ recipeHasIngredient.value }}</span>
            <select class="selectIngredient" data="{{ recipeHasIngredient.value }}">
              <option value="1">{{ recipeHasIngredient.ingredient.defaultUnit.symbol }}</option>
              {% for ingredientHasUnit in recipeHasIngredient.ingredient.units %}
              <option value="{{ ingredientHasUnit.value }}">{{ ingredientHasUnit.unit.symbol }}</option>
              {% endfor %}
            </select>
            {% else %}
            {{ recipeHasIngredient|getUnit }}
            {% endif %}
          </span>
        </li>
        {% endfor %}
        {% endfor %}
      </ul>
    </div>
    <div class="col s12">
      {% for step in recipe.steps %}
      <div>{{ step.text }}</div><br>
      {% endfor %}
    </div>
  </div>
</div>

<script>
function notifyBrowser(title, desc)
{
  if (Notification.permission !== "granted")
  {
    Notification.requestPermission();
  }
  var notification = new Notification(title, {
    icon:'https://www.google.fr/url?sa=i&rct=j&q=&esrc=s&source=images&cd=&cad=rja&uact=8&ved=0ahUKEwiKx--d7bPWAhXCNxQKHXrbCXwQjRwIBw&url=https%3A%2F%2Fwww.mql5.com%2Fen%2Fmarket%2Fproduct%2F4494&psig=AFQjCNERTK2i6oJ06xpbqyn9bwyKzAIxkg&ust=1505999974491909',
    body: desc,
  });
  /* Callback function when the notification is closed. */
  notification.onclose = function () {
    console.log('Notification closed');
  };
}

$(function() {
  function timer(){
    $(".chrono").each(function(){
      var run = $(this).attr("running");
      if (run == "true"){
        var data = $(this).attr("data");
        $(this).children(".time").html(timeToString(data));
        $(this).attr("data", --data)
        if (data == -1){
          notifyBrowser("Timer End", "");
          $(this).attr("running", false)
          $(this).children('.play').html("play_circle_filled");
        }
      }
    })
  }
  setInterval(timer, 1000);
});

$(".play.timer").click(function(){
  var data = $(this).parent('a');
  if (data.attr("running") == "true"){
    data.attr("running", false);
    data.children('.play').html("play_circle_filled");
  } else {
    data.attr("running", true);
    data.children('.play').html("pause_circle_filled");
    notifyBrowser("Timer started", timeToString(data.attr("data")) + " left");
  }
})

$(".reset.timer").click(function(){
  var data = $(this).parent('a');
  data.children('.play').html("play_circle_filled");
  data.attr("data", data.attr("init"));
  data.attr("running", false);
  $(this).prev('.time').html(timeToString(data.attr("init")));
})

function timeToString(time){
  var h, m, s;
  h = Math.floor(time / 3600);
  if (h<10) h = "0" + h;
  m = Math.floor(time % 3600 / 60);
  if (m<10) m = "0" + m;
  s = Math.floor(time % 3600 % 60);
  if (s<10) s = "0" + s;
  return (h + ' : ' + m + ' : ' + s);
}
</script>
{% endblock %}
